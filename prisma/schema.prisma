generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  cats      Cat[]
}

enum Activity {
  LOW
  NORMAL
  HIGH
}

model Cat {
  id         String   @id @default(uuid())
  userId     String
  name       String
  weightKg   Float
  ageYears   Int
  activity   Activity @default(NORMAL)
  sex        String   @default("不明")
  hairAmount String   @default("普通")
  size       String   @default("中型")
  neutered   Boolean  @default(false)
  allergies  String?
  createdAt  DateTime @default(now())

  user        User                   @relation(fields: [userId], references: [id])
  preferences IngredientPreference[]
  meals       Meal[]                 // 既存
  stoolLogs   StoolLog[]             // ★追加：同日カレンダーで表示する便ログ

  @@index([userId])
}

model Product {
  id               Int      @id @default(autoincrement())
  barcode          String   @unique
  name             String
  brand            String   @default("")
  ingredients_text String   @default("")
  image            String   @default("")
  source           String   @default("local")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  variants  ProductVariant[]

  // ★追加：MealItem（Product直付け）の逆参照
  mealItems MealItem[]   // ←これを足す
}

enum IngredientLevel {
  OK
  CAUTION
  NG
}

model IngredientPreference {
  id        String          @id @default(uuid())
  catId     String
  keyword   String
  level     IngredientLevel
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  cat Cat @relation(fields: [catId], references: [id])

  @@unique([catId, keyword])
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  form      String
  label     String
  lifeStage String?
  flavor    String  @default("")
  features  String?

  ingredients_text String @default("")

  // 一般的な保証分析（%）
  proteinMin  Float?
  fatMin      Float?
  fiberMax    Float?
  ashMax      Float?
  moistureMax Float?

  kcalPer100g Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])

  // MealItem からの逆参照
  mealItems MealItem[]

  @@unique([productId, form, label, flavor])
  @@index([productId])
  @@index([label])
  @@index([flavor])
  @@index([features])
  @@index([ingredients_text])
}

enum MealSlot {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

model Meal {
  id        Int        @id @default(autoincrement())
  catId     String
  cat       Cat        @relation(fields: [catId], references: [id])
  date      DateTime   // ログ対象日（00:00で統一保存推奨）
  slot      MealSlot
  notes     String?
  items     MealItem[]
  createdAt DateTime   @default(now())

  // 同一日・同一スロットを1行に集約（カレンダー描画が楽）
  @@unique([catId, date, slot])

  @@index([catId, date, slot])
  @@index([date])
}

model MealItem {
  id               Int             @id @default(autoincrement())
  mealId           Int
  meal             Meal            @relation(fields: [mealId], references: [id])

  productVariantId Int?
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])

  productId        Int?
  product          Product?        @relation(fields: [productId], references: [id])

  name             String?
  kcal             Float?
  ingredientsText  String?
  source           String?

  grams            Int

  @@index([productId])
  @@index([productVariantId])
}

/* うんちログ（カレンダー同日表示） */
enum StoolStatus {
  NONE      // 出ていない
  NORMAL    // 普通
  SOFT      // 軟便
  DIARRHEA  // 下痢（水様）
  HARD      // 硬い/便秘気味
}

model StoolLog {
  id        Int         @id @default(autoincrement())
  catId     String
  cat       Cat         @relation(fields: [catId], references: [id])
  date      DateTime    // 日付（00:00保存推奨）
  status    StoolStatus // 便性状
  color     String?     // 例: 黄/茶/黒/緑 など自由入力
  amount    String?     // 例: 少/普/多
  mucus     Boolean?    // 粘液の有無
  blood     Boolean?    // 血の有無
  note      String?     // メモ
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // 同一日1件に制約（1日に複数回記録したい場合は外してOK）
  @@unique([catId, date])

  @@index([catId, date])
}
